<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞–±—ñ–Ω–µ—Ç | –ú–µ–¥–∏—á–Ω–∞ –°–∏—Å—Ç–µ–º–∞</title>
    <style>
        /* –ó–ê–ì–ê–õ–¨–ù–ò–ô –°–¢–ò–õ–¨ */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f4f4; 
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 20px; 
            color: #333;
            font-size: 16px; 
        }
        .container { 
            max-width: 1100px; 
            margin: 0 auto; 
            background: white; 
            padding: 40px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-top: 5px solid #d32f2f; /* –ß–µ—Ä–≤–æ–Ω–∞ —à–∞–ø–∫–∞ */
        }
        
        /* –®–ê–ü–ö–ê */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }
        .header h2 { margin: 0; color: #d32f2f; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        .user-info { font-size: 18px; font-weight: bold; color: #555; }
        
        /* –°–ï–ö–¶–Ü–á */
        .section { 
            background: #fff; 
            border: 1px solid #e0e0e0; 
            padding: 30px; 
            margin-bottom: 30px; 
            border-radius: 6px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        h3 { 
            margin-top: 0; 
            color: #333; 
            font-size: 20px; 
            border-left: 5px solid #d32f2f; 
            padding-left: 15px; 
            margin-bottom: 20px;
        }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            color: white; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            text-decoration: none;
            transition: background 0.2s;
        }
        .btn-blue { background: #1976d2; } 
        .btn-blue:hover { background: #1565c0; }
        
        .btn-green { background: #388e3c; } 
        .btn-green:hover { background: #2e7d32; }
        
        .btn-gray { background: #757575; font-size: 14px; padding: 8px 16px; }
        .btn-gray:hover { background: #616161; }
        
        .btn-red { background: white; color: #d32f2f; border: 2px solid #d32f2f; }
        .btn-red:hover { background: #ffebee; }

        /* –ü–û–õ–Ø –í–í–û–î–£ */
        input, select { 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: #d32f2f; outline: none; }
        
        /* –ñ–ò–í–ò–ô –ü–û–®–£–ö */
        .search-wrapper { position: relative; width: 100%; }
        #searchInput { width: 100%; border: 2px solid #1976d2; }
        #searchResults { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: white; border: 1px solid #ddd; border-top: none; 
            z-index: 100; max-height: 250px; overflow-y: auto; display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 16px; }
        .search-item:hover { background-color: #e3f2fd; }
        
        /* –¢–ê–ë–õ–ò–¶–Ø */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16px; }
        th, td { padding: 15px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #f9f9f9; color: #d32f2f; font-weight: bold; text-transform: uppercase; font-size: 14px; border-bottom: 2px solid #d32f2f; }
        tr:hover { background-color: #fffafa; }
        
        /* –ö–ê–†–¢–ö–ê –õ–Ü–ö–ê–†–Ø (–ó–ï–õ–ï–ù–ê) */
        .doc-card { 
            border: 2px solid #388e3c; 
            padding: 25px; 
            background: #f1f8e9; 
            border-radius: 8px; 
            margin-top: 20px; 
        }

        /* –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –ü–†–û –ü–û–ú–ò–õ–ö–£ */
        .error-msg { 
            background: #ffebee; color: #c62828; 
            padding: 15px; border-radius: 4px; margin-bottom: 20px; 
            border-left: 5px solid #c62828; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2>üè• –ú–µ–¥–∏—á–Ω–∞ –°–∏—Å—Ç–µ–º–∞</h2>
            <div class="user-info" style="margin-top: 5px;">
                {% if role == 'doctor' %}üë®‚Äç‚öïÔ∏è –õ—ñ–∫–∞—Ä: {{ name }}
                {% else %}üë§ –ü–∞—Ü—ñ—î–Ω—Ç: {{ name }}
                {% endif %}
            </div>
        </div>
        <div>
            <a href="/logout" class="btn btn-red">–í–∏–π—Ç–∏ üö™</a>
        </div>
    </div>

    {% if role == 'doctor' %}
    <div class="section">
        <h3>üîç –ü–æ—à—É–∫ –ø–∞—Ü—ñ—î–Ω—Ç–∞</h3>
        
        {% if error %}
            <div class="error-msg">‚ö†Ô∏è {{ error }}</div>
        {% endif %}

        <p style="color:#666; margin-bottom:15px;">–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ —ñ–º'—è –ø–∞—Ü—ñ—î–Ω—Ç–∞, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –º–µ–¥–∫–∞—Ä—Ç–∏.</p>
        
        <form action="/dashboard" method="GET" style="display:flex; gap:10px;">
            <input type="text" name="patient_search" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –Ü–º'—è –ø–∞—Ü—ñ—î–Ω—Ç–∞..." style="width:60%;" value="{{ patient_search }}" required>
            <button type="submit" class="btn btn-blue">–ó–Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç–∫—É üîé</button>
        </form>
        
        {% if patient_search and not error %}
            <hr style="border:0; border-top:1px solid #eee; margin:30px 0;">
            <h4 style="font-size:20px; color:#d32f2f; margin-bottom: 20px;">üë§ –ü–∞—Ü—ñ—î–Ω—Ç: {{ patient_search }}</h4>
            
            <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom: 30px;">
                <form action="/add" method="POST" style="flex:1; background:#fffafa; padding:20px; border:1px solid #ffcdd2; border-radius:6px;">
                    <input type="hidden" name="type" value="prescription">
                    <input type="hidden" name="patient" value="{{ patient_search }}">
                    <b style="color:#d32f2f; font-size:18px;">üíä –í–∏–ø–∏—Å–∞—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</b><br><br>
                    <input type="text" name="med" placeholder="–ù–∞–∑–≤–∞ –ª—ñ–∫—ñ–≤ —Ç–∞ –¥–æ–∑—É–≤–∞–Ω–Ω—è" required style="width:100%; margin-bottom:10px;">
                    <button type="submit" class="btn btn-green" style="width:100%">–ó–±–µ—Ä–µ–≥—Ç–∏ ‚úÖ</button>
                </form>
                
                <form action="/add" method="POST" style="flex:1; background:#e3f2fd; padding:20px; border:1px solid #bbdefb; border-radius:6px;">
                    <input type="hidden" name="type" value="referral">
                    <input type="hidden" name="patient" value="{{ patient_search }}">
                    <b style="color:#1565c0; font-size:18px;">‚û°Ô∏è –î–∞—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</b><br><br>
                    <input type="text" name="target_spec" placeholder="–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å (–Ω–∞–ø—Ä. –•—ñ—Ä—É—Ä–≥)" required style="width:100%; margin-bottom:10px;">
                    <button type="submit" class="btn btn-blue" style="width:100%">–ù–∞–ø—Ä–∞–≤–∏—Ç–∏ ‚ûú</button>
                </form>
                
                <div style="flex:1; background:#f1f8e9; padding:20px; border:1px solid #c8e6c9; border-radius:6px;">
                    <b style="color:#2e7d32; font-size:18px;">üìÖ –ó–∞–ø–∏—Å–∞—Ç–∏ –¥–æ —Å–µ–±–µ</b><br><br>
                    
                    <form id="docApptForm" action="/dashboard" method="GET">
                        <input type="hidden" name="patient_search" value="{{ patient_search }}">
                        <input type="date" name="date" value="{{ selected_date }}" min="{{ today }}" 
                               onchange="document.getElementById('docApptForm').submit()" style="width:100%; margin-bottom:10px;">
                    </form>
                    
                    <form action="/add" method="POST">
                        <input type="hidden" name="type" value="appointment">
                        <input type="hidden" name="doctor" value="{{ name }}">
                        <input type="hidden" name="patient" value="{{ patient_search }}">
                        <input type="hidden" name="date" value="{{ selected_date }}">
                        
                        {% if current_doc.available_slots %}
                            <select name="time" style="width:100%; margin-bottom:10px;">
                                {% for slot in current_doc.available_slots %}
                                    <option value="{{ slot }}">{{ slot }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-green" style="width:100%;">–ó–∞–ø–∏—Å–∞—Ç–∏ ‚úÖ</button>
                        {% else %}
                            <div style="color:#c62828; font-weight:bold; margin-top:10px; text-align:center;">
                                {% if is_weekend %}üèñÔ∏è –í–∏—Ö—ñ–¥–Ω–∏–π{% else %}‚ùå –ù–µ–º–∞—î –º—ñ—Å—Ü—å{% endif %}
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>üìÇ –Ü—Å—Ç–æ—Ä—ñ—è —Ö–≤–æ—Ä–æ–±–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∞</h3>
                    <div>
                        <span style="color:#777; margin-right:10px;">–°–æ—Ä—Ç—É–≤–∞—Ç–∏:</span>
                        <a href="{{ url_for('dashboard', patient_search=patient_search, sort='asc') }}" style="text-decoration:none;"><button class="btn btn-gray">‚¨ÜÔ∏è –°—Ç–∞—Ä—ñ</button></a>
                        <a href="{{ url_for('dashboard', patient_search=patient_search, sort='desc') }}" style="text-decoration:none;"><button class="btn btn-gray">‚¨áÔ∏è –ù–æ–≤—ñ</button></a>
                    </div>
                </div>
                {% if records %}
                <table>
                    <thead><tr><th width="15%">–î–∞—Ç–∞</th><th width="25%">–õ—ñ–∫–∞—Ä</th><th width="15%">–¢–∏–ø –∑–∞–ø–∏—Å—É</th><th>–î–µ—Ç–∞–ª—ñ / –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</th></tr></thead>
                    <tbody>
                        {% for rec in records %}
                        <tr>
                            <td>{{ rec.date }}</td>
                            <td>{{ rec.doctor }}</td>
                            <td style="color:#d32f2f; font-weight:bold;">{{ rec.type }}</td>
                            <td>{{ rec.details }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %} 
                    <div style="text-align:center; padding:30px; color:#999; border: 2px dashed #eee; border-radius:6px;">–Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–ø–∏—Å—ñ–≤ –ø–æ—Ä–æ–∂–Ω—è.</div> 
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% endif %}

    {% if role == 'patient' %}
    <div class="section">
        <h3>üîç –ó–∞–ø–∏—Å –Ω–∞ –ø—Ä–∏–π–æ–º</h3>
        
        {% if not doctor_card %}
        <form id="selectDoctorForm" action="/dashboard" method="GET">
            <div class="search-wrapper">
                <label style="font-weight:bold; display:block; margin-bottom:10px; color:#555;">–ó–Ω–∞–π–¥—ñ—Ç—å –ª—ñ–∫–∞—Ä—è:</label>
                <input type="text" id="searchInput" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –ø—Ä—ñ–∑–≤–∏—â–µ –∞–±–æ —Ñ–∞—Ö (–Ω–∞–ø—Ä. –°—ñ–º–µ–π–Ω–∏–π)..." autocomplete="off" style="width:100%; padding:15px;">
                <input type="hidden" id="realDoctorInput" name="doctor_select">
                <div id="searchResults"></div>
            </div>
        </form>
        <p style="color:#777; margin-top:15px;">‚ÑπÔ∏è –í–≤–µ–¥—ñ—Ç—å –ø–µ—Ä—à—ñ –ª—ñ—Ç–µ—Ä–∏, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ª—ñ–∫–∞—Ä—ñ–≤.</p>
        
        {% else %}
        <div class="doc-card">
            <div style="margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="color:#2e7d32; margin:0;">üë®‚Äç‚öïÔ∏è {{ doctor_card.name }}</h2>
                    <a href="/dashboard" style="color:#777; text-decoration:none; font-weight:bold;">‚úï –ó–Ω–∞–π—Ç–∏ —ñ–Ω—à–æ–≥–æ</a>
                </div>
                <p style="font-size:18px; color:#555; margin-top:5px;">{{ doctor_card.spec }} | üïí –ó–º—ñ–Ω–∞: {{ doctor_card.shift }}</p>
            </div>
            
            <hr style="border:0; border-top:1px solid #a5d6a7; margin:20px 0;">

            <div style="display:flex; gap: 40px; align-items:flex-end; flex-wrap:wrap;">
                
                <form id="updateDateForm" action="/dashboard" method="GET" style="flex:1;">
                    <input type="hidden" name="doctor_select" value="{{ doctor_card.name }}">
                    <label style="font-weight:bold; color:#2e7d32;">1. –û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –ø—Ä–∏–π–æ–º—É:</label><br>
                    <input type="date" name="date" value="{{ selected_date }}" min="{{ today }}" 
                           onchange="document.getElementById('updateDateForm').submit()" 
                           style="width:100%; padding:15px; margin-top:10px; border:2px solid #388e3c; border-radius:4px; font-weight:bold; color:#333;">
                </form>

                <form action="/add" method="POST" style="flex:1;">
                    <input type="hidden" name="type" value="appointment">
                    <input type="hidden" name="doctor" value="{{ doctor_card.name }}">
                    <input type="hidden" name="date" value="{{ selected_date }}">
                    
                    <label style="font-weight:bold; color:#2e7d32;">2. –û–±–µ—Ä—ñ—Ç—å –≤—ñ–ª—å–Ω–∏–π —á–∞—Å:</label><br>
                    {% if doctor_card.available_slots %}
                        <div style="display:flex; gap:15px; align-items:center;">
                            <select name="time" style="width:100%; padding:15px; margin-top:10px; border:2px solid #388e3c; border-radius:4px; font-size:16px;">
                                {% for slot in doctor_card.available_slots %}
                                    <option value="{{ slot }}">{{ slot }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-green" style="height:52px; margin-top:10px; min-width:150px;">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—è ‚úÖ</button>
                        </div>
                    {% else %}
                        <div style="padding:15px; background:#ffebee; color:#c62828; border:1px solid #ef9a9a; border-radius:4px; margin-top:10px; text-align:center; font-weight:bold;">
                            {% if is_weekend %} üèñÔ∏è –£ —Ü–µ–π –¥–µ–Ω—å –≤–∏—Ö—ñ–¥–Ω–∏–π {% else %} ‚ùå –í—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—å –Ω–µ–º–∞—î {% endif %}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üìÇ –ú–æ—è –º–µ–¥–∏—á–Ω–∞ –∫–∞—Ä—Ç–∫–∞</h3>
            <div>
                <a href="{{ url_for('dashboard', doctor_select=request.args.get('doctor_select'), sort='asc') }}" style="text-decoration:none;"><button class="btn btn-gray">‚¨ÜÔ∏è –°—Ç–∞—Ä—ñ</button></a>
                <a href="{{ url_for('dashboard', doctor_select=request.args.get('doctor_select'), sort='desc') }}" style="text-decoration:none;"><button class="btn btn-gray">‚¨áÔ∏è –ù–æ–≤—ñ</button></a>
            </div>
        </div>
        {% if records %}
        <table>
            <thead><tr><th width="15%">–î–∞—Ç–∞</th><th width="25%">–õ—ñ–∫–∞—Ä</th><th width="15%">–¢–∏–ø –∑–∞–ø–∏—Å—É</th><th>–î–µ—Ç–∞–ª—ñ</th></tr></thead>
            <tbody>
                {% for rec in records %}
                <tr>
                    <td>{{ rec.date }}</td>
                    <td>{{ rec.doctor }}</td>
                    <td style="font-weight:bold; color: #1976d2;">{{ rec.type }}</td>
                    <td>{{ rec.details }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %} 
            <div style="text-align:center; padding:30px; color:#999; border: 2px dashed #eee; border-radius:6px;">–ó–∞–ø–∏—Å—ñ–≤ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î.</div> 
        {% endif %}
    </div>
    {% endif %}

</div>

<script>
    // JS –¥–ª—è –ñ–∏–≤–æ–≥–æ –ü–æ—à—É–∫—É (–ë–µ–∑ –∑–º—ñ–Ω –ª–æ–≥—ñ–∫–∏, —Ç—ñ–ª—å–∫–∏ —Å—Ç–∏–ª—å)
    const doctorsData = {{ all_doctors | tojson }};
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('searchResults');
    const form = document.getElementById('selectDoctorForm');
    
    if(searchInput) {
        searchInput.addEventListener('keyup', function() {
            const val = this.value.toLowerCase();
            resultsDiv.innerHTML = '';
            if(val.length < 1) { resultsDiv.style.display='none'; return; }
            const filtered = doctorsData.filter(d => d.name.toLowerCase().includes(val) || d.spec.toLowerCase().includes(val));
            if(filtered.length){
                resultsDiv.style.display='block';
                filtered.forEach(d => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    // –î–æ–¥–∞—î–º–æ —ñ–∫–æ–Ω–∫—É –ª—ñ–∫–∞—Ä—è –¥–ª—è –∫—Ä–∞—Å–∏
                    div.innerHTML = `üë®‚Äç‚öïÔ∏è <b>${d.name}</b> <span style="color:#666">(${d.spec})</span>`;
                    div.onclick = () => { document.getElementById('realDoctorInput').value=d.name; form.submit(); };
                    resultsDiv.appendChild(div);
                });
            } else { resultsDiv.style.display='none'; }
        });
        document.addEventListener('click', function(e) { if (e.target !== searchInput) resultsDiv.style.display = 'none'; });
    }
</script>

</body>
</html>